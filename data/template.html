<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset='utf-8'>
    <title>ReadPaper 文件管理</title>
    <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>
    <meta name="theme-color" content="#757575">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='12' height='14' x='2' y='1' rx='1' fill='%23757575'/><rect width='8' height='2' x='4' y='3' fill='%23fff'/><rect width='6' height='1' x='5' y='6' fill='%23fff'/><rect width='8' height='1' x='4' y='8' fill='%23fff'/><rect width='4' height='1' x='6' y='10' fill='%23fff'/></svg>">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #424242;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            /* leave room for fixed banner */
            padding-top: 76px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Fixed top banner recommending browser extension */
        .fixed-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff8e1;
            /* light yellow */
            color: #5a3b00;
            padding: 10px 16px;
            text-align: center;
            z-index: 10000;
            border-bottom: 1px solid #ffe082;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .header h1 {
            color: #212121;
            font-size: 2.5rem;
            font-weight: 400;
            margin-bottom: 10px;
        }

        .header p {
            color: #757575;
            font-size: 1.1rem;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            background: #f5f5f5;
            color: #424242;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .tab-buttons {
            display: flex;
            gap: 0;
            width: 100%;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            color: #424242;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: -1px;
            flex: 1;
            text-align: center;
        }

        .tab-btn.active {
            background: white;
            color: #212121;
            border-bottom: 2px solid #757575;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: #fafafa;
        }

        .tab-btn.active:hover {
            background: white;
        }

        .card-body {
            padding: 20px;
        }

        /* 上传区域 */
        .upload-area {
            border: 2px dashed #bdbdbd;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            position: relative;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #e0e0e0;
            color: #424242;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid #bdbdbd;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn {
            padding: 10px 25px;
            background: #757575;
            color: white;
            border: 1px solid #616161;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            min-height: 36px;
        }

        .upload-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
        }

        #uploadStatus {
            margin-top: 15px;
            padding: 10px;
            font-weight: 500;
            min-height: 20px;
        }

        /* 文件列表 */
        .file-list {
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
            align-content: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
            min-width: 200px;
        }

        .file-details {
            flex: 1;
        }

        .file-name-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            width: 100%;
            justify-content: space-between;
            flex-wrap: nowrap;
        }

        .file-name {
            flex: 1 1 auto;
            font-weight: 600;
            color: #333;
            word-break: break-all;
            margin-right: 8px;
            min-width: 0;
        }

        .file-size {
            font-size: 0.8rem;
            color: #757575;
            margin-right: 12px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .file-actions-inline {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            align-items: center;
            margin-left: auto;
            justify-content: flex-end;
            flex: 0 0 auto;
        }

        .btn-icon {
            width: auto;
            height: auto;
            padding: 4px 8px;
            border: 1px solid #bdbdbd;
            background: #f0f0f0;
            color: #616161;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: none;
            min-width: 40px;
        }

        .btn-icon:hover {
            background: #e0e0e0;
            border-color: #9e9e9e;
        }

        .btn-download {
            text-decoration: none;
        }

        .btn-download:hover {
            text-decoration: none;
        }

        .btn {
            padding: 6px 12px;
            text-decoration: none;
            font-weight: 500;
            border: 1px solid #bdbdbd;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 30px;
            white-space: nowrap;
            background: #e0e0e0;
            color: #424242;
        }

        /* 更明显的禁用删除按钮样式 */
        .btn-delete[disabled],
        .btn-delete:disabled {
            background: linear-gradient(180deg, #f5f5f5, #e0e0e0);
            color: #9e9e9e;
            border-color: #dcdcdc;
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: none;
            pointer-events: none;
            /* 防止鼠标事件 */
            position: relative;
        }

        /* 在禁用按钮旁显示显著的标签样式（在当前项使用） */
        .current-badge {
            display: inline-block;
            background: #ffecb3;
            color: #795548;
            border: 1px solid #ffd54f;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 6px;
            font-weight: 600;
        }

        .btn-primary {
            background: #9e9e9e;
            color: #212121;
            border-color: #757575;
        }

        /* Sync button styling */
        .sync-row {
            justify-content: space-around;
            background: #eeeeee;
            /* solid flat color */
        }

        .sync-row #syncTimeBtn {
            padding: 8px 14px;
            border-radius: 0;
            /* flat */
            background: #9e9e9e;
            /* solid flat color */
            color: #ffffff;
            border: 1px solid #757575;
            box-shadow: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .sync-row #syncTimeBtn:active {
            background: #808080;
            /* slightly darker when pressed */
            transform: none;
        }

        .sync-row #repoBtn {
            padding: 8px 14px;
            border-radius: 0;
            /* flat */
            background: #757575;
            /* slightly different shade */
            color: #ffffff;
            border: 1px solid #616161;
            box-shadow: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .sync-row #repoBtn:active {
            background: #616161;
            /* darker when pressed */
            transform: none;
        }

        .sync-row #repoBtn:hover {
            background: #616161;
        }

        /* Unified top action button style */
        .sync-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 45%;
        }

        .sync-row .top-action {
            box-sizing: border-box;
            flex: 0 0 48%;
            max-width: 50%;
            width: 48%;
            justify-content: center;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .top-action.link {
            text-decoration: none;
        }

        /* Right-align file list action buttons */
        .file-name-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .file-actions-inline {
            margin-left: auto;
            justify-content: flex-end;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Top-right descriptive text: slightly smaller and left-aligned */
        .sync-row .sync-desc {
            font-size: 0.85rem;
            color: #757575;
            text-align: left;
            line-height: 1.2;
            display: inline-block;
            max-width: 60%;
        }

        .btn-danger {
            background: #757575;
            color: white;
            border-color: #616161;
        }

        .btn-success {
            background: #9e9e9e;
            color: #212121;
            border-color: #757575;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card-body {
                padding: 15px;
            }

            .upload-area {
                padding: 30px 15px;
            }

            .file-input-label,
            .upload-btn {
                padding: 8px 15px;
                font-size: 0.95rem;
                min-height: 40px;
            }

            .file-item {
                padding: 12px 15px;
                flex-direction: row;
                align-items: flex-start;
            }

            .file-name-row {
                width: 100%;
            }

            .file-actions-inline {
                margin-left: auto;
            }

            .btn-icon {
                width: auto;
                height: auto;
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 44px;
            }

            .btn {
                padding: 8px 15px;
                min-height: 40px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .card-header {
                padding: 15px;
                font-size: 1.2rem;
                gap: 12px;
            }

            .tab-buttons {
                width: 100%;
                justify-content: space-between;
                border-bottom: 1px solid #e0e0e0;
            }

            .tab-btn {
                flex: 1;
                padding: 8px 12px;
                font-size: 0.9rem;
                margin-bottom: -1px;
            }

            .upload-area {
                padding: 20px 10px;
            }

            .file-input-label,
            .upload-btn {
                width: 100%;
                margin-bottom: 10px;
                padding: 12px 20px;
                min-height: 44px;
            }

            .file-item {
                padding: 12px 15px;
                flex-direction: row;
                align-items: flex-start;
            }

            .file-name-row {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .file-name {
                margin-right: 0;
                margin-bottom: 4px;
                width: 100%;
            }

            .file-size {
                font-size: 0.75rem;
                margin-right: 8px;
                margin-bottom: 4px;
            }

            .card-header {
                padding: 12px;
                font-size: 1.1rem;
                gap: 10px;
            }

            .tab-buttons {
                gap: 0;
            }

            .tab-btn {
                padding: 6px 8px;
                font-size: 0.8rem;
                margin-bottom: -1px;
            }
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f0f0f0;
            border-top: 2px solid #757575;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast notification styles */
        #toasts {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 220px;
            max-width: 420px;
            background: #fff;
            color: #222;
            border-radius: 6px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid #9e9e9e;
            font-weight: 500;
        }

        .toast .toast-body {
            flex: 1;
            font-size: 0.95rem;
        }

        .toast .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #777;
            cursor: pointer;
        }

        .toast-success {
            border-left-color: #43a047;
        }

        .toast-error {
            border-left-color: #e53935;
        }

        .toast-info {
            border-left-color: #1e88e5;
        }

        /* 状态消息样式 */
        .status-success {
            background-color: #f0f0f0;
            color: #424242;
            border: 1px solid #e0e0e0;
        }

        .status-error {
            background-color: #f5f5f5;
            color: #616161;
            border: 1px solid #e0e0e0;
        }

        .status-info {
            background-color: #fafafa;
            color: #757575;
            border: 1px solid #e0e0e0;
        }

        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination .btn {
            min-width: 80px;
        }

        .pagination #pageInfo {
            font-weight: 500;
            color: #424242;
            white-space: nowrap;
        }

        /* Tab提示样式 */
        .tab-hint {
            background: #f0f0f0;
            color: #616161;
            padding: 12px 16px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Mobile / touch improvements */
        html,
        body {
            -ms-touch-action: manipulation;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        /* make tab buttons horizontally scrollable on small screens */
        .tab-buttons {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            min-width: 110px;
            /* improve tap target */
            padding: 10px 14px;
        }

        /* larger, easier-to-tap buttons globally on mobile */
        .btn {
            min-height: 44px;
            padding: 10px 16px;
            border-radius: 6px;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ensure file-item actions wrap and become full width when narrow */
        .file-actions-inline {
            gap: 8px;
            flex-wrap: wrap;
        }

        /* optimize the sync/repo row for narrow screens: stack vertically */
        .sync-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sync-row>div {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* More aggressive mobile rules */
        @media (max-width: 600px) {
            .sync-row {
                flex-direction: column;
                align-items: stretch;
            }

            .sync-row>div {
                width: 100%;
            }

            .sync-row #syncTimeBtn,
            .sync-row #repoBtn {
                width: 48%;
                min-width: 140px;
            }

            /* on very small screens make them full width */
            @media (max-width: 420px) {

                .sync-row #syncTimeBtn,
                .sync-row #repoBtn {
                    width: 100%;
                }
            }

            .file-item {
                padding: 12px;
            }

            .file-input-label {
                padding: 12px;
                font-size: 0.95rem;
            }

            .upload-area {
                padding: 20px;
            }

            .card-body {
                padding: 14px;
            }
        }

        /* active feedback for touch devices */
        .btn:active {
            transform: translateY(1px);
        }
    </style>
</head>

<body>
    <div class='fixed-banner'>
        V1.3版本之后，推荐使用
        <a href="https://chromewebstore.google.com/detail/readpaper-utils/fgkgjmmeoaojnhkeiebbibgbodikmgoe"
            target="_blank" rel="noopener noreferrer"
            style="background:#FFA500!important;ortant; color:#000 !important; text-decoration:none !important; padding:3px 6px; border-radius:4px;">
            Chrome
        </a>
        |
        <a href="https://microsoftedge.microsoft.com/addons/detail/readpaper-utils/ablggfkhbegbnlgjbleoklekinmglnia"
            target="_blank" rel="noopener noreferrer"
            style="background:#FFA500!important; color:#000 !important; text-decoration:none !important; padding:3px 6px; border-radius:4px;">
            Edge
        </a>
        |
        <a href="https://addons.mozilla.org/zh-CN/firefox/addon/readpaper-utils/" target="_blank"
            rel="noopener noreferrer"
            style="background:#FFA500!important; color:#000 !important; text-decoration:none !important; padding:3px 6px; border-radius:4px;">
            Firefox
        </a>

        浏览器扩展进行管理
    </div>
    <div class='container'>
        <div class='header'>
            <h1>ReadPaper <span id="curver"></span></h1>
            <hr>
            <div class='sync-row' style='margin-top:12px; flex-wrap:wrap;'>
                <div class='sync-item'>
                    <button id='syncTimeBtn' class='btn btn-primary top-action' onclick='syncTime()'>同步时间</button>
                    <span class='sync-desc'>用本机时间为PaperS3同步</span>
                </div>
                <div class='sync-item'>
                    <a id='repoBtn' class='btn top-action link' href='https://github.com/shinemoon/M5ReadPaper'
                        target='_blank' rel='noopener noreferrer'>支持仓库</a>
                    <span class='sync-desc'>GitHub仓库(字体、壁纸相关)</span>
                </div>
            </div>
        </div>

        <div class='card'>
            <div class='card-header'>
                文件列表
                <div class='tab-buttons'>
                    <button class='tab-btn active' onclick='switchTab("book")'>书籍</button>
                    <button class='tab-btn' onclick='switchTab("font")'>字体</button>
                    <button class='tab-btn' onclick='switchTab("image")'>屏保</button>
                    <button class='tab-btn' onclick='switchTab("screenshot")'>截图</button>
                    <button class='tab-btn' onclick='switchTab("records")'>阅读记录</button>
                </div>
            </div>
            <div class='card-body'>
                <div id='tabHint' class='tab-hint'>支持unicode/GBK编码的txt文件 </div>
                <div id='fileList' class='file-list'>
                    <div class='file-item loading'>正在加载文件列表...</div>
                </div>
                <div id='pagination' class='pagination' style='display: none; text-align: center; margin-top: 20px;'>
                    <button id='prevBtn' class='btn' onclick='changePage(-1)' disabled>上一页</button>
                    <span id='pageInfo' style='margin: 0 15px;'>第 1 页</span>
                    <button id='nextBtn' class='btn' onclick='changePage(1)'>下一页</button>
                </div>
            </div>

            <div class='card'>
                <div class='card-header'>
                    <span id='uploadTitle'>书籍-文件上传</span>
                </div>
                <div class='card-body'>
                    <form id='uploadForm' enctype='multipart/form-data'>
                        <div class='upload-area' id='uploadArea'>
                            <div class='file-input-wrapper'>
                                <input type='file' name='data' id='fileInput' multiple class='file-input'>
                                <label for='fileInput' class='file-input-label'>
                                    选择文件 (支持多选)
                                </label>
                            </div>
                            <button type='button' class='upload-btn' onclick='uploadFiles()' id='uploadBtn'>
                                开始上传
                            </button>
                            <div id='uploadHint'
                                style='text-align: center; margin-top: 10px; font-size: 0.85rem; color: #757575; font-style: italic;'>
                            </div>
                            <div id='uploadStatus'></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    </div>

    <!-- toast container for non-blocking alerts -->
    <div id="toasts" aria-live="polite" aria-atomic="true"></div>

    <!-- removed stray closing script tag above -->

    <!-- confirm modal -->
    <div id="confirmModal" class="confirm-modal" style="display:none;">
        <div class="confirm-backdrop"></div>
        <div class="confirm-box">
            <div id="confirmMessage" style="margin-bottom:12px;"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button id="confirmNo" class="btn">取消</button>
                <button id="confirmYes" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>

    <style>
        .confirm-modal {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-backdrop {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
        }

        .confirm-box {
            position: relative;
            background: white;
            padding: 16px;
            border-radius: 6px;
            min-width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            z-index: 10001;
        }
    </style>

    <script>
        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const msg = document.getElementById('confirmMessage');
                const yes = document.getElementById('confirmYes');
                const no = document.getElementById('confirmNo');
                msg.textContent = message;
                modal.style.display = 'flex';
                function cleanup(result) {
                    modal.style.display = 'none';
                    yes.removeEventListener('click', onYes);
                    no.removeEventListener('click', onNo);
                    resolve(result);
                }
                function onYes() { cleanup(true); }
                function onNo() { cleanup(false); }
                yes.addEventListener('click', onYes);
                no.addEventListener('click', onNo);
            });
        }
        let selectedFiles = [];
        let currentTab = 'book'; // 当前选中的tab
        let currentPage = 1; // 当前页码
        let fileCache = { book: null, font: null, image: null, screenshot: null, records: null };
        const PAGE_SIZE = 10;

        // Tab切换功能
        function switchTab(tabName, ev) {
            // ev is optional; when provided, use it to update active button
            currentTab = tabName;
            currentPage = 1;
            
            // 更新active按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                // 通过按钮的onclick属性匹配当前tab
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`"${tabName}"`)) {
                    btn.classList.add('active');
                }
            });
            
            const hintElement = document.getElementById('tabHint');
            const hints = {
                'book': '支持unicode/GBK编码的txt',
                'font': '请确认上传的是专用工具生成的font.bin文件(部分推荐字体可于上方仓库链接直接下载 ), V1.2.9之前生成的字体，建议重新生成更新。',
                'image': '尽量避免使用大图片，体积太大可能会导致无法使用并回退系统锁屏，540x960尺寸为佳 （建议用上方仓库提供工具生成），锁屏优先选择文件同名图片，其次可部分匹配文件名（但可以带额外数字结尾）的图片，再次default.png，之后回退系统自带。',
                'screenshot': '设备截图存储目录。双击屏幕左上角(230,0)-(310,80)区域可触发截图。此目录仅支持下载和删除，不支持上传。',
                'records': '查看所有书籍的阅读记录统计信息。包括总阅读时长、每日统计和每月统计。此功能仅显示统计信息，不支持上传和删除。'
            };
            hintElement.textContent = hints[tabName] || '';

            // 更新上传标题
            const tabNames = {
                'book': '书籍',
                'font': '字体',
                'image': '锁屏',
                'screenshot': '截图',
                'records': '阅读记录'
            };
            const uploadTitle = document.getElementById('uploadTitle');
            uploadTitle.textContent = `${tabNames[tabName] || tabName}-文件上传`;

            // 对于screenshot和records tab，隐藏上传区域（找到uploadForm的祖父元素.card）
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                // uploadForm -> .card-body -> .card
                const uploadCard = uploadForm.closest('.card');
                if (uploadCard) {
                    if (tabName === 'screenshot' || tabName === 'records') {
                        uploadCard.style.display = 'none';
                    } else {
                        uploadCard.style.display = 'block';
                    }
                }
            }

            loadFileList();
        }

        // 分页功能
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1) return;
            const files = fileCache[currentTab] || [];
            const maxPage = Math.ceil(files.length / PAGE_SIZE);
            if (newPage > maxPage) return;
            currentPage = newPage;
            renderFileList();
        }

        // 文件拖拽功能
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            // do not await drop handler (fire-and-forget)
            handleFiles(files);
        }

        async function handleFiles(files) {
            selectedFiles = Array.from(files);

            // 检查是否有同名文件需要覆盖（仅当文件列表已加载时）
            const existingFiles = fileCache[currentTab];
            if (existingFiles) {
                const conflictingFiles = selectedFiles.filter(file =>
                    existingFiles.some(existing => existing.name === file.name)
                );

                if (conflictingFiles.length > 0) {
                    const fileNames = conflictingFiles.map(f => f.name).join(', ');
                    const confirmed = await showConfirm(`以下文件已存在，上传将覆盖原有文件：\n${fileNames}\n\n是否继续？`);
                    if (!confirmed) {
                        // 用户取消，清除选择
                        selectedFiles = [];
                        document.getElementById('fileInput').value = '';
                        updateFileInput();
                        updateUploadButton();
                        return;
                    }
                }
            }

            updateFileInput();
            updateUploadButton();
        }

        function updateFileInput() {
            // 更新显示的文件名
            const fileNames = selectedFiles.map(f => f.name).join(', ');
            const label = document.querySelector('.file-input-label');
            if (selectedFiles.length > 0) {
                label.innerHTML = `已选择 ${selectedFiles.length} 个文件: ${fileNames}`;
            } else {
                label.innerHTML = '选择文件 (支持多选)';
            }
        }

        function updateUploadButton() {
            const btn = document.getElementById('uploadBtn');
            btn.disabled = selectedFiles.length === 0;
            if (selectedFiles.length > 0) {
                btn.innerHTML = `上传 ${selectedFiles.length} 个文件`;
            } else {
                btn.innerHTML = '开始上传';
            }
        }

        fileInput.addEventListener('change', function (e) {
            // file input change: await the async handler but don't block UI
            handleFiles(e.target.files);
        });

        function uploadFiles() {
            const statusDiv = document.getElementById('uploadStatus');

            if (selectedFiles.length === 0) {
                showStatus('请选择文件', 'error');
                return;
            }

            // 检查文件大小 - 20MB限制，保持稳定性优化
            const maxSize = 20 * 1024 * 1024; // 20MB
            let totalSize = 0;
            for (let file of selectedFiles) {
                if (file.size > maxSize) {
                    showStatus(`文件 ${file.name} 过大，请选择小于20MB的文件`, 'error');
                    return;
                }
                totalSize += file.size;
            }

            // 检查总文件大小
            if (totalSize > 50 * 1024 * 1024) { // 50MB总限制
                showStatus('选择的文件总大小过大，请分批上传（总计不超过50MB）', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = '上传中...';

            // 依次上传每个文件
            uploadFilesSequentially(0, uploadBtn);
        }

        async function performUpload(file, onProgress) {
            // Try upload with automatic retries and exponential backoff.
            const maxRetries = 2; // 最多自动重试次数（失败后重试）
            const baseDelay = 500; // ms

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    const xhr = new XMLHttpRequest();

                    const uploadPromise = new Promise((resolve, reject) => {
                        xhr.upload.onprogress = (e) => {
                            if (e.lengthComputable && typeof onProgress === 'function') {
                                onProgress(e.loaded, e.total);
                            }
                        };

                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                const responseText = xhr.responseText.trim();
                                try {
                                    const j = JSON.parse(responseText || '{}');
                                    if (j && typeof j.ok !== 'undefined') {
                                        if (j.ok) {
                                            resolve(j.message || 'OK');
                                        } else {
                                            reject(new Error(j.message || '上传失败'));
                                        }
                                        return;
                                    }
                                } catch (e) {
                                    // 非JSON响应，继续作为成功处理
                                }
                                // HTTP 200 legacy success
                                resolve(responseText || 'OK');
                            } else {
                                reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                            }
                        };

                        xhr.onerror = () => {
                            reject(new Error('network'));
                        };

                        xhr.ontimeout = () => reject(new Error('timeout'));

                        xhr.timeout = 300000; // 5分钟客户端超时（足够大）
                        xhr.open('POST', `/upload?tab=${encodeURIComponent(currentTab)}`);
                        const fd = new FormData();
                        fd.append('data', file);
                        xhr.send(fd);
                    });

                    const res = await uploadPromise;
                    return res;
                } catch (err) {
                    // on network errors, try to verify via /list if the server may have accepted the file
                    if (err.message === 'network' || err.message.toLowerCase().includes('http')) {
                        // small delay before verification to let server flush
                        await new Promise(r => setTimeout(r, 400));
                        try {
                            const r = await fetch(`/list/${encodeURIComponent(currentTab)}`);
                            if (r.ok) {
                                const files = await r.json();
                                const exists = files.some(f => f.name === file.name);
                                if (exists) {
                                    return 'OK (verified via listing)';
                                }
                            }
                        } catch (e) {
                            // ignore verification failure and proceed to retry
                        }
                    }

                    if (attempt < maxRetries) {
                        const delay = baseDelay * Math.pow(2, attempt);
                        showToast(`上传失败，正在重试（第 ${attempt + 1} 次）...`, 'info', 2000);
                        await new Promise(r => setTimeout(r, delay));
                        continue; // retry
                    }
                    // 最后一次失败，抛出错误
                    throw err;
                }
            }
        }

        async function uploadFilesSequentially(index, uploadBtn) {
            if (index >= selectedFiles.length) {
                // 所有文件上传完成
                showStatus('所有文件上传完成！', 'success');
                selectedFiles = [];
                updateFileInput();
                updateUploadButton();

                // 清除文件输入框，允许重新选择相同文件
                document.getElementById('fileInput').value = '';

                loadFileList();
                uploadBtn.disabled = false;
                uploadBtn.textContent = '开始上传';
                return;
            }

            const file = selectedFiles[index];
            const formData = new FormData();
            formData.append('data', file);

            const fileSize = (file.size / 1024).toFixed(1);
            showStatus(`正在上传 ${file.name} (${fileSize} KB)... ${index + 1}/${selectedFiles.length}`, 'info');

            try {
                const uploadStartTime = Date.now();

                const result = await performUpload(file, (loaded, total) => {
                    const percent = ((loaded / total) * 100).toFixed(1);
                    showStatus(`上传 ${file.name}: ${percent}% (${index + 1}/${selectedFiles.length})`, 'info');
                });

                const uploadTime = ((Date.now() - uploadStartTime) / 1000).toFixed(1);
                showStatus(`${file.name} 上传成功 (耗时: ${uploadTime}s)`, 'success');

                // 继续下一个文件
                setTimeout(() => uploadFilesSequentially(index + 1, uploadBtn), 400);

            } catch (error) {
                // 更友好的错误信息
                let errorMessage = `上传 ${file.name} 失败: `;
                const msg = (error && error.message) ? error.message.toString() : '';
                if (msg.includes('timeout')) {
                    errorMessage += '上传超时，请检查网络连接';
                } else if (msg.includes('413')) {
                    errorMessage += '文件过大';
                } else if (msg.includes('500')) {
                    errorMessage += '服务器错误，可能是磁盘空间或写入权限问题';
                } else if (msg === 'network') {
                    errorMessage += '网络错误（可能已上传，或连接中断）';
                } else {
                    errorMessage += msg || '未知错误';
                }

                showStatus(errorMessage, 'error');

                // 询问用户：是否重新上传当前失败的文件？
                // 如果用户选择放弃，则继续上传队列中的下一个文件。
                const retryThis = await showConfirm(`${errorMessage}\n\n是否重新上传此文件？ 点击“是”重试，点击“否”放弃并继续下一个文件。`);
                if (retryThis) {
                    // 重新尝试上传当前文件
                    setTimeout(() => uploadFilesSequentially(index, uploadBtn), 1000);
                } else {
                    // 放弃当前文件，继续下一个（如果有）
                    if (index + 1 < selectedFiles.length) {
                        setTimeout(() => uploadFilesSequentially(index + 1, uploadBtn), 1000);
                    } else {
                        // 没有更多文件，重置 UI
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = '开始上传';
                        document.getElementById('fileInput').value = '';
                    }
                }
            }
        }

        function updateUploadStatus(fileCount) {
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadHint = document.getElementById('uploadHint');

            if (fileCount === 0) {
                // 目录为空时的提示
                uploadBtn.disabled = false;
                uploadHint.textContent = "何处见那'遁去的一'？";
                uploadHint.style.color = '#757575';
            } else if (fileCount >= 99) {
                // 文件超过99个时禁用上传并提示
                uploadBtn.disabled = true;
                uploadHint.textContent = "宁缺毋滥，九九归一";
                uploadHint.style.color = '#d32f2f';
            } else {
                // 正常状态
                uploadBtn.disabled = false;
                uploadHint.textContent = '';
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = message;
            statusDiv.className = `status-${type}`;
        }

        function loadFileList() {
            const fileList = document.getElementById('fileList');
            const pagination = document.getElementById('pagination');
            fileList.innerHTML = '<div class="file-item loading">正在加载文件列表...</div>';
            pagination.style.display = 'none';
            
            console.log('[DEBUG] loadFileList called for tab:', currentTab);
            
            // 特殊处理阅读记录标签，使用不同的API端点
            if (currentTab === 'records') {
                fetch('/api/reading_records')
                    .then(response => {
                        console.log('[DEBUG] fetch reading records response status:', response.status);
                        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DEBUG] reading records loaded:', data.processed, '/', data.total, 'records');
                        fileCache[currentTab] = data.records || [];
                        renderReadingRecords();
                    })
                    .catch(error => {
                        console.error('[DEBUG] loadFileList error:', error);
                        fileList.innerHTML = `<div class="file-item" style="justify-content: space-evenly; color: #d32f2f; flex-direction: row; margin-top: 20px;">
                            <div style="margin-bottom: 10px;">加载失败: ${error.message}</div>
                            <button onclick="loadFileList()" style="padding: 8px 16px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">重试</button>
                        </div>`;
                    });
                return;
            }
            
            // 只请求一次，缓存
            fetch(`/list/${currentTab}`)
                .then(response => {
                    console.log('[DEBUG] fetch response status:', response.status);
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(files => {
                    console.log('[DEBUG] files loaded:', files.length, 'files');
                    fileCache[currentTab] = files;
                    renderFileList();
                })
                .catch(error => {
                    console.error('[DEBUG] loadFileList error:', error);
                    fileList.innerHTML = `<div class="file-item" style="justify-content: space-evenly; color: #d32f2f; flex-direction: row; margin-top: 20px;">
                        <div style="margin-bottom: 10px;">加载失败: ${error.message}</div>
                        <button onclick="loadFileList()" style="padding: 8px 16px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">重试</button>
                    </div>`;
                });
        }

        function renderFileList() {
            const fileList = document.getElementById('fileList');
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadHint = document.getElementById('uploadHint');
            const files = fileCache[currentTab] || [];

            // 更新上传按钮状态和提示
            updateUploadStatus(files.length);

            fileList.innerHTML = '';
            if (files.length === 0) {
                fileList.innerHTML = '<div class="file-item" style="justify-content: center; color: #6c757d;">暂无文件</div>';
                pagination.style.display = 'none';
                return;
            }
            // 分页
            const startIdx = (currentPage - 1) * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, files.length);
            const pageFiles = files.slice(startIdx, endIdx);

            /*
            // 调试：添加一个假的文件项
            const debugItem = document.createElement('div');
            debugItem.className = 'file-item';
            const debugIconClass = 'file-icon';
            const debugDirPrefix = currentTab === 'book' ? '/book' : currentTab === 'font' ? '/font' : currentTab === 'image' ? '/image' : '';
            const debugFullPath = debugDirPrefix + '/debug_test_file.txt';
            debugItem.innerHTML = `
                <div class="file-info">
                    <div class="${debugIconClass}"></div>
                    <div class="file-details">
                        <div class="file-name-row">
                            <span class="file-name">debug_test_file.txt</span>
                            <span class="file-size">1.2 KB</span>
                            <div class="file-actions-inline">
                                <a href='/download?path=${debugFullPath}' class='btn-icon btn-download' title='下载'>下载</a>
                                <button onclick='deleteFile("${debugFullPath}")' class='btn-icon btn-delete' title='删除'>删除</button>
                            </div>
                        </div>
                        <div class="file-meta">
                        </div>
                    </div>
                </div>
            `;
            fileList.appendChild(debugItem);
            */

            pageFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                const iconClass = file.type === 'file' ? 'file-icon' : 'folder-icon file-icon';
                const dirPrefix = currentTab === 'book' ? '/book' : currentTab === 'font' ? '/font' : currentTab === 'image' ? '/image' : currentTab === 'screenshot' ? '/screenshot' : '';
                // Prefer server-supplied full path (untruncated). Fallback to constructed path.
                const fullPath = file.path ? file.path : (dirPrefix + '/' + file.name);
                item.innerHTML = `
                    <div class="file-info">
                        <div class="${iconClass}"></div>
                        <div class="file-details">
                            <div class="file-name-row">
                                <span class="file-name">${file.name}</span>
                                ${file.isCurrent ? (currentTab === 'book' ? '<span class="current-badge">正在阅读</span>' : (currentTab === 'font' ? '<span class="current-badge">当前字体</span>' : '<span class="current-badge">当前</span>')) : ''}
                                <span class="file-size">${file.type === 'file' ? formatFileSize(file.size) : ''}</span>
                                <div class="file-actions-inline">
                                    ${file.type === 'file' ?
                        `<a href='/download?path=${encodeURIComponent(fullPath)}' class='btn-icon btn-download' title='下载'>下载</a>` :
                        ''
                    }
                                    ${file.isCurrent ?
                        `<button disabled class='btn-icon btn-delete' title='Cannot delete the currently opened book'>删除</button>` :
                        `<button onclick='deleteFile("${fullPath.replace(/"/g, '&quot;')}")' class='btn-icon btn-delete' title='删除'>删除</button>`
                    }
                                </div>
                            </div>
                            <div class="file-meta">
                                ${file.type === 'dir' ? '文件夹' : ''}
                            </div>
                        </div>
                    </div>
                `;
                fileList.appendChild(item);
            });
            // 分页控件
            pagination.style.display = 'block';
            const maxPage = Math.ceil(files.length / PAGE_SIZE);
            const startFile = startIdx + 1;
            const endFile = endIdx;
            pageInfo.textContent = `${currentPage}/${maxPage}`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= maxPage;
        }

        function renderReadingRecords() {
            const fileList = document.getElementById('fileList');
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const records = fileCache[currentTab] || [];

            fileList.innerHTML = '';
            if (records.length === 0) {
                fileList.innerHTML = '<div class="file-item" style="justify-content: center; color: #6c757d;">暂无阅读记录</div>';
                pagination.style.display = 'none';
                return;
            }

            // 分页
            const startIdx = (currentPage - 1) * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, records.length);
            const pageRecords = records.slice(startIdx, endIdx);

            pageRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.style.flexDirection = 'column';
                item.style.alignItems = 'flex-start';
                item.style.gap = '10px';
                
                // 格式化总时长
                const totalTime = `${record.total_hours}小时${record.total_minutes}分钟`;
                
                // 计算最近阅读时间
                let lastReadDate = '';
                const dailyKeys = Object.keys(record.daily_summary || {}).sort().reverse();
                if (dailyKeys.length > 0) {
                    const lastDay = dailyKeys[0];
                    lastReadDate = `${lastDay.substr(0,4)}-${lastDay.substr(4,2)}-${lastDay.substr(6,2)}`;
                }
                
                // 计算本月阅读时长
                const now = new Date();
                const currentMonth = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0');
                const thisMonthMinutes = record.monthly_summary ? (record.monthly_summary[currentMonth] || 0) : 0;
                const thisMonthHours = Math.floor(thisMonthMinutes / 60);
                const thisMonthMins = thisMonthMinutes % 60;
                
                item.innerHTML = `
                    <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 600; color: #333; word-break: break-all; flex: 1;">${record.book_name}</div>
                        <div style="font-size: 0.9rem; color: #757575; white-space: nowrap; margin-left: 10px;">总计: ${totalTime}</div>
                    </div>
                    ${lastReadDate ? `<div style="font-size: 0.85rem; color: #9e9e9e;">最近阅读: ${lastReadDate}</div>` : ''}
                    ${thisMonthMinutes > 0 ? `<div style="font-size: 0.85rem; color: #9e9e9e;">本月阅读: ${thisMonthHours}小时${thisMonthMins}分钟</div>` : ''}
                    <div style="width: 100%; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick='showRecordDetails(${JSON.stringify(record).replace(/'/g, "&#39;")})' 
                                style="padding: 6px 12px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                            查看详细统计
                        </button>
                    </div>
                `;
                
                fileList.appendChild(item);
            });

            // 更新分页控件
            pagination.style.display = records.length > PAGE_SIZE ? 'block' : 'none';
            if (records.length > PAGE_SIZE) {
                const maxPage = Math.ceil(records.length / PAGE_SIZE);
                const startFile = startIdx + 1;
                const endFile = endIdx;
                pageInfo.textContent = `${currentPage}/${maxPage}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= maxPage;
            }
        }

        function showRecordDetails(record) {
            // 构建详细统计信息的HTML
            let detailsHTML = `
                <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
                    <h3 style="margin-bottom: 15px; color: #424242;">${record.book_name}</h3>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 1.1rem; color: #424242; margin-bottom: 10px;">
                            <strong>总阅读时长:</strong> ${record.total_hours}小时${record.total_minutes}分钟
                        </div>
                    </div>
            `;
            
            // 按月统计
            if (record.monthly_summary && Object.keys(record.monthly_summary).length > 0) {
                detailsHTML += '<div style="margin-bottom: 20px;"><h4 style="color: #616161; margin-bottom: 8px;">月度统计</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">';
                const monthKeys = Object.keys(record.monthly_summary).sort().reverse();
                monthKeys.forEach(month => {
                    const minutes = record.monthly_summary[month];
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    const monthStr = `${month.substr(0,4)}年${month.substr(4,2)}月`;
                    detailsHTML += `<div style="padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 0.9rem;">${monthStr}: ${hours}h${mins}m</div>`;
                });
                detailsHTML += '</div></div>';
            }
            
            // 按日统计（最近30天）
            if (record.daily_summary && Object.keys(record.daily_summary).length > 0) {
                detailsHTML += '<div style="margin-bottom: 20px;"><h4 style="color: #616161; margin-bottom: 8px;">最近30天</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 6px;">';
                const dayKeys = Object.keys(record.daily_summary).sort().reverse().slice(0, 30);
                dayKeys.forEach(day => {
                    const minutes = record.daily_summary[day];
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    const dateStr = `${day.substr(4,2)}月${day.substr(6,2)}日`;
                    detailsHTML += `<div style="padding: 6px; background: #fafafa; border-radius: 4px; font-size: 0.85rem;">${dateStr}: ${hours}h${mins}m</div>`;
                });
                detailsHTML += '</div></div>';
            }
            
            detailsHTML += '</div>';
            
            // 使用toast或modal显示详细信息（这里简化为alert，可以改为更好的UI）
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    ${detailsHTML}
                    <div style="padding: 15px; border-top: 1px solid #e0e0e0; text-align: right;">
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="padding: 8px 20px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        async function deleteFile(path) {
            const ok = await showConfirm(`确认删除 ${path} ?`);
            if (!ok) return;
            fetch('/delete?path=' + encodeURIComponent(path))
                .then(response => response.json())
                .then(obj => {
                    if (obj && obj.ok) {
                        showToast(obj.message || '删除成功', 'success', 4000);
                    } else {
                        showToast((obj && obj.message) ? obj.message : '删除失败', 'error', 6000);
                    }
                    // 删除后重新拉取列表
                    fileCache[currentTab] = null;
                    loadFileList();
                })
                .catch(error => {
                    showToast('删除失败: ' + error.message, 'error', 6000);
                });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化上传标题
            const uploadTitle = document.getElementById('uploadTitle');
            uploadTitle.textContent = '书籍-文件上传';

            loadFileList();
            updateUploadButton();
        });

        // 添加触摸设备优化
        if ('ontouchstart' in window) {
            document.body.classList.add('touch-device');
        }

        // 同步浏览器时间到设备
        function syncTime() {
            const btn = document.getElementById('syncTimeBtn');
            btn.disabled = true;
            btn.textContent = '同步中...';

            const now = new Date();
            const payload = {
                timestamp: Math.floor(now.getTime() / 1000),
                iso: now.toISOString(),
                tzOffsetMinutes: new Date().getTimezoneOffset() // minutes ahead of UTC (note sign)
            };

            console.log('[SYNC_TIME] sending', payload);

            fetch('/sync_time', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.text()).then(txt => {
                    console.log('[SYNC_TIME] response:', txt);
                    showToast('同步完成：' + txt, 'success', 3500);
                }).catch(err => {
                    console.error('[SYNC_TIME] failed', err);
                    showToast('同步失败：' + err.message, 'error', 6000);
                }).finally(() => {
                    btn.disabled = false;
                    btn.textContent = '同步时间';
                });
        }

        // ---- Toast notification helper ----
        function showToast(message, type = 'info', timeout = 3000) {
            try {
                const container = document.getElementById('toasts');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'status');
                toast.innerHTML = `
                    <div class="toast-body">${message}</div>
                    <button class="toast-close" aria-label="Close">&times;</button>
                `;
                // close handler
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    container.removeChild(toast);
                });
                container.appendChild(toast);
                // auto remove
                if (timeout > 0) {
                    setTimeout(() => {
                        if (toast.parentNode === container) container.removeChild(toast);
                    }, timeout);
                }
            } catch (e) {
                // fallback to native alert if something goes wrong
                try { alert(message); } catch (e) { }
            }
        }
    </script>
</body>

</html>